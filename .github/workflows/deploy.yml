name: Deploy to Server

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.15.0'
          cache: 'npm'
          cache-dependency-path: package-lock.json
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run linter
        run: npm run lint
        
      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            cd /var/www/boxpro
            # Обновляем submodule в основном репозитории
            git submodule update --remote frontend
            cd frontend
            # Сохраняем storage перед обновлением
            if [ -d "public/storage" ]; then
              cp -r public/storage /tmp/storage-backup-$(date +%s)
            fi
            # Получаем последние изменения
            git fetch origin
            git checkout master 2>/dev/null || git checkout main
            git pull origin master 2>/dev/null || git pull origin main
            # Восстанавливаем storage если он был удален
            LATEST_BACKUP=$(ls -td /tmp/storage-backup-* 2>/dev/null | head -1)
            if [ ! -d "public/storage" ] && [ -n "$LATEST_BACKUP" ] && [ -d "$LATEST_BACKUP" ]; then
              cp -r "$LATEST_BACKUP" public/storage
            fi
            # Пересобираем Docker контейнер
            cd /var/www
            docker-compose -f docker-compose.boxpro.yml build --no-cache
            docker-compose -f docker-compose.boxpro.yml up -d --force-recreate
