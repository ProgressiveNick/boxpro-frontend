name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.15.0'
          cache: 'npm'
          cache-dependency-path: package-lock.json
          
      - name: Install dependencies
        run: npm ci
        
      - name: Load environment variables
        run: |
          # Создаем .env.local из .env.frontend для Next.js
          # Переменные можно взять из GitHub Secrets или из файла .env.frontend
          # Если .env.frontend есть в репозитории, используем его
          if [ -f ".env.frontend" ]; then
            cp .env.frontend .env.local
          elif [ -f "../.env.frontend" ]; then
            cp ../.env.frontend .env.local
          else
            # Создаем .env.local из GitHub Secrets
            cat > .env.local << EOF
          STRAPI_API_BASE_URL=\${{ secrets.STRAPI_API_BASE_URL }}
          STRAPI_API_TOKEN=\${{ secrets.STRAPI_API_TOKEN }}
          TELEGRAM_BOT_TOKEN=\${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID=\${{ secrets.TELEGRAM_CHAT_ID }}
          NEXT_PUBLIC_STRAPI_API_URL=\${{ secrets.NEXT_PUBLIC_STRAPI_API_URL }}
          NEXT_PUBLIC_STRAPI_URL=\${{ secrets.NEXT_PUBLIC_STRAPI_URL }}
          EOF
          fi
        env:
          STRAPI_API_BASE_URL: ${{ secrets.STRAPI_API_BASE_URL }}
          STRAPI_API_TOKEN: ${{ secrets.STRAPI_API_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          NEXT_PUBLIC_STRAPI_API_URL: ${{ secrets.NEXT_PUBLIC_STRAPI_API_URL }}
          NEXT_PUBLIC_STRAPI_URL: ${{ secrets.NEXT_PUBLIC_STRAPI_URL }}
        
      - name: Run linter
        run: |
          if [ -f "eslint.config.mjs" ] || [ -f ".eslintrc.json" ] || [ -f ".eslintrc.js" ]; then
            npm run lint || echo "Linting completed with warnings"
          else
            echo "No ESLint config found, skipping lint step"
          fi
        continue-on-error: true
        
      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
          # Переменные окружения из GitHub Secrets для сборки
          STRAPI_API_BASE_URL: ${{ secrets.STRAPI_API_BASE_URL }}
          STRAPI_API_TOKEN: ${{ secrets.STRAPI_API_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          NEXT_PUBLIC_STRAPI_API_URL: ${{ secrets.NEXT_PUBLIC_STRAPI_API_URL }}
          NEXT_PUBLIC_STRAPI_URL: ${{ secrets.NEXT_PUBLIC_STRAPI_URL }}
          
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            cd /var/www/boxpro
            # Обновляем submodule в основном репозитории
            git submodule update --remote frontend
            cd frontend
            # Сохраняем storage перед обновлением
            if [ -d "public/storage" ]; then
              cp -r public/storage /tmp/storage-backup-$(date +%s)
            fi
            # Получаем последние изменения
            git fetch origin
            git checkout main
            git pull origin main
            # Копируем .env.frontend в .env.local для Next.js
            if [ -f "../.env.frontend" ]; then
              cp ../.env.frontend .env.local
              echo "✅ .env.frontend скопирован в .env.local"
            else
              echo "⚠️  .env.frontend не найден, используем переменные из docker-compose"
            fi
            # Восстанавливаем storage если он был удален
            LATEST_BACKUP=$(ls -td /tmp/storage-backup-* 2>/dev/null | head -1)
            if [ ! -d "public/storage" ] && [ -n "$LATEST_BACKUP" ] && [ -d "$LATEST_BACKUP" ]; then
              cp -r "$LATEST_BACKUP" public/storage
            fi
            # Пересобираем Docker контейнер
            cd /var/www
            docker-compose -f docker-compose.boxpro.yml build --no-cache
            docker-compose -f docker-compose.boxpro.yml up -d --force-recreate
